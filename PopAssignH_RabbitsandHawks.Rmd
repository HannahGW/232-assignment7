---
title: "Rabbits & Hawks"
author: "Hannah Garcia, Kat Leigh, & Anthony Luna"
date: "5/15/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Upload packages
library(sensitivity)
library(tidyverse)
library(ggplot2)
library(dplyr)
```

```{r}
# read in function
source("evolve_pop.r")
```

```{r}
# set up fertility and survivability of rabbits
# fertility rates
f1 = 0
f2 = 1
f3 = 3
f4 = 0.5

# survivability 
p1 = 0.8
p2 = 0.85
p3 = 0.65
p4 = 0.1

# set up initial population parameters
ini = c(0, 0, 10, 0)
nyears = 20
fert_rabbits = c(f1,f2,f3,f4)
surv_rabbits = c(p1, p2, p3, p4)
rabbits_pop=evolve_pop(fert_rabbits, surv_rabbits, ini, nyears)
  
head(rabbits_pop)

# q1: what is the total rabbit population after 20 years?
rabbits_pop$poptot # 24,421 rabbits

# q2: how many young rabbits (first age class) are there in the population at that time?
# 18,371 rabbits <-- this doesn't seem right?

## ---------------------------------------------------------------------------
# extra - plots to visualize rabbit population
# add year 
year = seq(from=1, to=nyears)
rabbits_tot = cbind.data.frame(year=year, poptot=rabbits_pop$poptot)
ggplot(rabbits_tot, aes(year, poptot))+geom_col()+labs(y="total population")

# plot information about ages
rabbits_ages = cbind.data.frame(year=year, t(rabbits_pop$popbyage))
rabbits_agesl = rabbits_ages %>% gather(key="agecat", value="pop",-year)
ggplot(rabbits_agesl, aes(year, pop, fill=agecat))+geom_col()+labs(y="population", fill="age group")

```



## sensitivity analysis

hawks generally only eat  younger rabbits- thus they reduce the survivability of the young and sub-adults age classes (the first two classes).  the estimates are that survivability reduced to between 0.65 and 0.75 for ages 0-1 and between 0.75 and 0.8 for ages 1-2. you can assume that distributions are uniform

plot how total rabbit population after 20 years varies with a) survivability of young age and b) young adult.  also generate a box plot of the variation in total rabbit population.  how does this compare with total rabbit population after 20 years in your original population model (without the hawk related change to survivability)?

```{r sobel-data-setup}
nsample = 200
# set up fertility and survivability of rabbits
# fertility rates
parm_sample_1 <- cbind.data.frame(
  # fertility
  f1 = 0,
  f2 = 1,
  f3 = 3,
  f4 = 0.5,
  # survivability 
  p1 = runif(min=0.65,max=0.75,n=nsample),
  p2 = runif(min=0.75,max=0.85,n=nsample),
  p3 = 0.65,
  p4 = 0.1
)

parm_sample_2 <- cbind.data.frame(
  # fertility
  f1 = 0,
  f2 = 1,
  f3 = 3,
  f4 = 0.5,
  # survivability 
  p1 = runif(min=0.65,max=0.75,n=nsample),
  p2 = runif(min=0.75,max=0.85,n=nsample),
  p3 = 0.65,
  p4 = 0.1
)

sensitivity_data <- soboljansen(model=NULL,parm_sample_1,parm_sample_2,nboot=100)

head(sensitivity_data$X)
nrow(sensitivity_data$X)
```

```{r ad-hoc-function}
p_wrapper = function(p1, p2, p3, p4, f1, f2, f3, f4, use_func, initialpop, nstep) {
  fertility=c(f1,f2,f3,f4)
  survivability= c(p1, p2, p3, p4)
  res = use_func(survivability =survivability, fertility = fertility, initialpop=initialpop, nstep=nstep)
  # now return the final population total
  return(finalpop=res$poptot[nstep])
}
```


```{r implement-sensitivity-analysis}

nyears=20
# use pmap here so we can specify rows of our sensitivity analysis parameter object 
res = as.data.frame(sensitivity_data$X) %>% pmap_dbl(p_wrapper, initialpop=ini, nstep=nyears, use_func=evolve_pop)
```





```{r}

# plot results (variation in final population across all parameter)
# ggplot needs a dataframe - so do a quick conversion with data.frame
ggplot(data.frame(finalpop=res), aes(x=finalpop))+geom_density()

# or a boxplot
ggplot(data.frame(finalpop=res), aes(x="", y=finalpop/1000) )+geom_boxplot(fill="blue")+
  theme(axis.title.x = element_blank())+labs(y="Final Pop (in 1000s)")

# give our results to sensitivity structure

sens_micro=tell(sensitivity_data, res)

# look at results
sens_micro$S
sens_micro$T

# graph the most sensitive parameter
tmp = cbind.data.frame(sens_micro$X, pop1=sens_micro$y)
ggplot(tmp, aes(p1, pop1))+geom_point()+labs(x="Survivability of rabbits aged 0-1",y="Population after 20 years")
```

